name: build
on:
  push:
    paths-ignore:
     - 'README.md'
  pull_request:
    paths-ignore:
     - 'README.md'
  workflow_dispatch:
    inputs:
      version:
        description: dummy
        default: dummy

jobs:
  update-nightly-tag:
    name: Update nightly release tag
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    permissions:
        contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Move nightly tag to head for nightly release
        run: git tag -f nightly && git push origin nightly -f

  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: test docker
      run: |
        docker --version

    - name: list java class files
      run: |
        find . -name '*.class'

    - name: delete java class files
      run: |
        find . -name '*.class'|xargs rm -v

    - name: build and test android version
      run: |
        export RUNTESTS=1 ; ./compile_docker_all.sh || (cat compile.log; exit 1)

    - name: Rename artifact for nightly upload
      run: |
        cp -av ./003_src_iocipher/libiocipher2-c/build/outputs/aar/libiocipher2-c-release.aar ./
        cp -av ./003_src_iocipher/libiocipher2-c/build/outputs/aar/libiocipher2-c-debug.aar ./
        cp -av ./003_src_iocipher/stub_work/local_maven_iocipher_1.0.1.zip ./

    - name: Upload to nightly release
      uses: ncipollo/release-action@v1
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      with:
        allowUpdates: true
        tag: nightly
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        prerelease: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: "local_maven_iocipher_*.zip,libiocipher2-c-release.aar,libiocipher2-c-debug.aar,compile.log"

    - name: build and test linux version
      run: |
        cd 003_src_iocipher/linux_jni/c_src && ./compile_linux_c.sh || (cat compile.log; exit 1)

    - name: rename linux c_src compile.log
      run: |
        cp -v 003_src_iocipher/linux_jni/c_src/compile.log ./compile_linux_c_src.log

    - name: move linux c_src jar
      run: |
        cp -v 003_src_iocipher/linux_jni/c_src/iocipher_linux-*.jar ./

    - name: Upload to nightly release
      uses: ncipollo/release-action@v1
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      with:
        allowUpdates: true
        tag: nightly
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        prerelease: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: "iocipher_linux-*.jar,compile_linux_c_src.log"
